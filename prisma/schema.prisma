generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @map("updated_at")
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model User {
  id                   String                @id @default(cuid())
  name                 String?
  email                String?               @unique
  image                String?
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @default(now()) @map("updated_at")
  role                 UserRole              @default(USER)
  storageLimit         BigInt                @default(1073741824)
  storageUsed          BigInt                @default(0)
  clerkId              String?               @unique
  isActive             Boolean               @default(true)
  suspendedAt          DateTime?
  suspendedById        String?
  suspensionReason     String?
  QuizAttempt          QuizAttempt[]
  Account              Account[]
  chats                Chat[]
  ownedEnrollments     EnrollActivity[]      @relation("EnrollActivitiesOwner")
  enrollments          EnrollActivity[]      @relation("EnrollActivitiesUser")
  lessonProgress       LessonProgress[]
  PilotOwnerRequests   PilotOwnerRequests?
  ownerSchedules       Schedule[]            @relation("OwnerSchedules")
  userSchedules        Schedule[]            @relation("UserSchedules")
  Session              Session[]
  users                User?                 @relation("usersTousers", fields: [suspendedById], references: [id])
  other_users          User[]                @relation("usersTousers")

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model File {
  id              String   @id @default(cuid())
  name            String
  preview         String?
  key             String
  file_class_type String
  size            Int
  type            String
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now()) @updatedAt
  Lesson          Lesson?
  Pilot           Pilot?

  @@map("files")
}

model Pilot {
  id              String           @id @default(cuid())
  ownerId         String           @map("owner_id")
  title           String
  description     String
  thumbnailFileId String?          @unique
  category        String
  isPublished     Boolean          @default(false) @map("is_published")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime?        @map("updated_at")
  QuizInfo        QuizInfo[]
  enrollments     EnrollActivity[] @relation("PilotEnrollments")
  lessons         Lesson[]         @relation("PilotLessons")
  thumbnailFile   File?            @relation(fields: [thumbnailFileId], references: [id])
  schedules       Schedule[]

  @@map("pilots")
}

model Lesson {
  id              String           @id @default(cuid())
  orderNumber     Int              @map("order_number")
  title           String
  description     String?
  tutorialVideoID String?          @unique @map("tutorial_video_id")
  isPublished     Boolean          @default(false) @map("is  _published")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime?        @map("updated_at")
  pilotId         String           @map("pilot_id")
  duration        Int
  progress        LessonProgress[]
  pilot           Pilot            @relation("PilotLessons", fields: [pilotId], references: [id])
  tutorialVideo   File?            @relation(fields: [tutorialVideoID], references: [id])
  Note            Note[]

  @@map("lessons")
}

model Note {
  id              String    @id @default(cuid())
  lessonId        String
  name            String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime?
  key             String
  preview         String?
  size            Int
  type            String
  file_class_type String
  Lesson          Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("notes")
}

model Chat {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  messages  Json
  userId    String
  updatedAt DateTime? @default(now())
  user      User      @relation(fields: [userId], references: [id])

  @@map("chats")
}

model EnrollActivity {
  id           Int          @id @default(autoincrement())
  userId       String       @map("user_id")
  ownerId      String       @map("owner_id")
  pilotId      String       @map("pilot_id")
  enrollStatus EnrollStatus @default(PENDING) @map("enroll_status")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  approvedAt   DateTime?    @map("approved_at")
  owner        User         @relation("EnrollActivitiesOwner", fields: [ownerId], references: [id])
  pilot        Pilot        @relation("PilotEnrollments", fields: [pilotId], references: [id])
  user         User         @relation("EnrollActivitiesUser", fields: [userId], references: [id])

  @@map("enrollActivities")
}

model QuizInfo {
  id        String        @id @default(cuid())
  title     String
  summary   String?
  pilotId   String
  setAsExam Boolean       @default(false)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  questions Question[]
  attempts  QuizAttempt[]
  pilot     Pilot         @relation(fields: [pilotId], references: [id])
  settings  QuizSettings?
}

model Question {
  id             String       @id @default(cuid())
  question       String
  type           QuestionType
  points         Int          @default(10)
  description    String?
  answerRequired Boolean      @default(true)
  randomize      Boolean      @default(false)
  explanation    String?
  quizInfoId     String
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  options        Option[]
  quizInfo       QuizInfo     @relation(fields: [quizInfoId], references: [id], onDelete: Cascade)
  answers        UserAnswer[]
}

model Option {
  id         String   @id @default(cuid())
  text       String
  isCorrect  Boolean
  questionId String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model QuizSettings {
  id                 String        @id @default(cuid())
  timeLimit          Int?
  hideQuizTime       Boolean       @default(false)
  feedbackMode       FeedbackMode
  passingGrade       Float?
  attemptsAllowed    Int?
  autoStart          Boolean       @default(false)
  questionOrder      QuestionOrder @default(sequential)
  hideQuestionNumber Boolean       @default(false)
  quizInfoId         String        @unique
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")
  quizInfo           QuizInfo      @relation(fields: [quizInfoId], references: [id], onDelete: Cascade)
}

model QuizAttempt {
  id         String       @id @default(cuid())
  quizInfoId String
  userId     String
  startedAt  DateTime     @default(now())
  finishedAt DateTime?
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")
  quizInfo   QuizInfo     @relation(fields: [quizInfoId], references: [id])
  user       User         @relation(fields: [userId], references: [id])
  result     QuizResult?
  answers    UserAnswer[]
}

model UserAnswer {
  id                String      @id @default(cuid())
  questionId        String
  attemptId         String
  selectedOptionIds String[]
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  attempt           QuizAttempt @relation(fields: [attemptId], references: [id])
  question          Question    @relation(fields: [questionId], references: [id])
}

model QuizResult {
  id        String      @id @default(cuid())
  attemptId String      @unique
  score     Float       @default(0)
  passed    Boolean
  feedback  String?
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  attempt   QuizAttempt @relation(fields: [attemptId], references: [id])
}

model LessonProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  progress    Float     @default(0)
  isCompleted Boolean   @default(false)
  lastWatched Float     @default(0)
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("lesson_progress")
}

model Schedule {
  id                String         @id @default(cuid())
  pilotId           String
  userId            String
  ownerId           String
  scheduledDateTime DateTime
  message           String?
  finalMessage      String?
  status            ScheduleStatus @default(PENDING)
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  owner             User           @relation("OwnerSchedules", fields: [ownerId], references: [id])
  pilot             Pilot          @relation(fields: [pilotId], references: [id])
  user              User           @relation("UserSchedules", fields: [userId], references: [id])

  @@index([userId])
  @@index([ownerId])
  @@index([pilotId])
  @@index([status])
  @@map("schedules")
}

model PilotOwnerRequests {
  id            String    @id @default(cuid())
  userId        String?   @unique
  name          String
  email         String
  organization  String
  contactNumber String
  purpose       String
  processedAt   DateTime?
  processedBy   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  status        String    @default("PENDING")
  users         User?     @relation(fields: [userId], references: [id])

  @@map("pilot_owner_requests") 
}

enum UserRole {
  PILOTOWNER
  USER
  SUPERADMIN
}

enum EnrollStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ScheduleStatus {
  PENDING
  ACCEPTED
  FINALIZEDVIAEMAIL
}

enum QuestionType {
  single
  multiple
  true_false
}

enum FeedbackMode {
  default
  review
  retry
}

enum QuestionOrder {
  random
  sequential
}

enum PilotOwnerRequestStatus {
  PENDING
  APPROVED
  REJECTED
}
